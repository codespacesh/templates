#!/bin/bash
# claude-session: Start Claude Code in a numbered tmux session
# Usage: claude-session [--wait-for-claude] [SESSION_NUMBER]
#   --wait-for-claude  Wait up to 60s for claude CLI to become available
#   SESSION_NUMBER     Session number (default: 1). Creates session "claude-1", "claude-2", etc.
set -e

PROJECT_NAME="${PROJECT_NAME:-}"
WORKDIR="/home/coder/${PROJECT_NAME}"

# Parse args
WAIT_FOR_CLAUDE=false
SESSION_NUM=""
for arg in "$@"; do
  case "$arg" in
    --wait-for-claude) WAIT_FOR_CLAUDE=true ;;
    *) SESSION_NUM="$arg" ;;
  esac
done

# Default session number: next available
if [ -z "$SESSION_NUM" ]; then
  SESSION_NUM=1
  while tmux has-session -t "claude-${SESSION_NUM}" 2>/dev/null; do
    SESSION_NUM=$((SESSION_NUM + 1))
  done
fi

SESSION_NAME="claude-${SESSION_NUM}"

# Auth check
if [ -z "$CLAUDE_CODE_OAUTH_TOKEN" ] && [ -z "$CLAUDE_API_KEY" ]; then
  echo "claude-session: no auth configured, skipping"
  exit 0
fi

# Skip if no issue
if [ -z "$ISSUE_NUMBER" ]; then
  echo "claude-session: no issue number, skipping"
  exit 0
fi

# Wait for Claude CLI (installed by claude-code module)
if [ "$WAIT_FOR_CLAUDE" = true ]; then
  for i in {1..30}; do
    command -v claude &>/dev/null && break
    sleep 2
  done
fi
if ! command -v claude &>/dev/null; then
  echo "claude-session: claude CLI not found, skipping"
  exit 0
fi

# Skip if this specific session already exists
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
  echo "claude-session: ${SESSION_NAME} already exists, use: claude-attach ${SESSION_NUM}"
  exit 0
fi

# Build prompt
ISSUE_MARKER="/home/coder/.claude_started_issue_${ISSUE_NUMBER}"
PROMPT_FILE="/tmp/claude-prompt-${SESSION_NUM}.txt"

if [ -f "$ISSUE_MARKER" ]; then
  cat > "$PROMPT_FILE" <<EOF
=== WORKSPACE RESTARTED ===

Previous work on GitHub Issue #${ISSUE_NUMBER} has already been started.
ISSUE: ${ISSUE_TITLE}

Before taking any action:
1. Check current state: git status && git diff
2. Review the branch: git branch
3. Wait for instructions before making changes
EOF
else
  echo "$(date): Started issue #${ISSUE_NUMBER}" > "$ISSUE_MARKER"
  cat > "$PROMPT_FILE" <<EOF
You are working on GitHub Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

## Your task
1. Run \`gh issue view ${ISSUE_NUMBER}\` to read the full issue and comments
2. Check out the branch: \`${ISSUE_BRANCH}\`
3. Understand the codebase and implement the changes
4. Run tests and verify your changes work
5. Commit your changes and push the branch
6. Create a pull request linking to issue #${ISSUE_NUMBER}
EOF
fi

# Start tmux session with interactive claude
# Heredoc feeds the prompt to claude's stdin (same approach as sonica/scripts/coder/claude-init.sh)
PROMPT=$(cat "$PROMPT_FILE")

tmux new-session -d -s "$SESSION_NAME" \
  "cd ${WORKDIR} && claude <<'CLAUDE_PROMPT_EOF'
${PROMPT}
CLAUDE_PROMPT_EOF
"

echo "claude-session: ${SESSION_NAME} started (attach with: claude-attach ${SESSION_NUM})"
