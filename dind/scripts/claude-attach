#!/bin/bash
# claude-attach: Attach to a Claude Code tmux session
# Usage: claude-attach [SESSION_NUMBER]
#   No args    — list active sessions, or attach if only one exists
#   NUMBER     — attach to claude-NUMBER

# List all claude sessions
list_sessions() {
  local sessions
  sessions=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | grep '^claude-' | sort -t- -k2 -n)
  if [ -z "$sessions" ]; then
    echo "No Claude sessions running."
    echo "Start one with: claude-session"
    return 1
  fi
  echo "Active Claude sessions:"
  while IFS= read -r s; do
    num="${s#claude-}"
    echo "  ${num}) ${s}"
  done <<< "$sessions"
  echo ""
  echo "Attach with: claude-attach <number>"
}

if [ -z "$1" ]; then
  # No arg: if exactly one session, attach to it; otherwise list
  sessions=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | grep '^claude-')
  count=$(echo "$sessions" | grep -c . 2>/dev/null || echo 0)
  if [ "$count" -eq 1 ]; then
    exec tmux attach -t "$sessions"
  elif [ "$count" -gt 1 ]; then
    list_sessions
    exit 0
  else
    echo "No Claude sessions running."
    echo "Start one with: claude-session"
    exit 1
  fi
else
  SESSION_NAME="claude-${1}"
  if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    exec tmux attach -t "$SESSION_NAME"
  else
    echo "Session ${SESSION_NAME} not found."
    list_sessions
    exit 1
  fi
fi
